<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Фильмы в кинотеатре</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .movie-poster {
            height: 400px; /* Увеличено с 300px */
            width: 100%;
            object-fit: cover;
        }
        .no-poster {
            height: 400px; /* Увеличено для соответствия */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            text-align: center;
            padding: 15px;
        }
        .card {
            height: 100%;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .poster-container {
            height: 400px;
            overflow: hidden;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}">Кинотеатр</a>
        <div class="navbar-nav">
            <a class="nav-link active" th:href="@{/booking/movies}">Фильмы</a>
            <a class="nav-link" th:href="@{/customer/tickets}">Мои билеты</a>
            <a class="nav-link" th:href="@{/customer/dashboard}">Личный кабинет</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2>Фильмы в прокате</h2>

    <div th:if="${movies == null or movies.empty}" class="alert alert-info mt-4">
        В данный момент нет фильмов в прокате.
    </div>

    <div class="row mt-4">
        <div th:each="movie : ${movies}" class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <!-- КОНТЕЙНЕР ДЛЯ ИЗОБРАЖЕНИЯ -->
                <div class="poster-container">
                    <!-- Если есть изображение -->
                    <img th:if="${movie.posterUrl != null and movie.posterUrl != ''}"
                         th:src="@{'/posters/' + ${movie.posterUrl}}"
                         class="movie-poster"
                         th:alt="${movie.title}"
                         onerror="showFallback(this)">

                    <!-- Заглушка ТОЛЬКО если нет изображения -->
                    <div th:if="${movie.posterUrl == null or movie.posterUrl == ''}"
                         class="no-poster">
                        <div th:text="${movie.title}"></div>
                    </div>
                </div>

                <div class="card-body">
                    <h5 class="card-title" th:text="${movie.title}"></h5>
                    <p>
                        <span class="badge bg-primary" th:text="${movie.genre}"></span>
                        <span class="badge bg-secondary ms-2" th:text="${movie.durationMinutes} + ' мин'"></span>
                        <span th:if="${movie.ageRating}" class="badge bg-warning text-dark ms-2">
                            <span th:text="${movie.ageRating}"></span>
                        </span>
                    </p>
                    <p class="card-text">
                        <span th:if="${movie.description != null and movie.description.length() > 100}">
                            [[${movie.description.substring(0, 100)}...]]
                        </span>
                        <span th:if="${movie.description != null and movie.description.length() <= 100}">
                            [[${movie.description}]]
                        </span>
                        <span th:if="${movie.description == null}">
                            Описание отсутствует
                        </span>
                    </p>
                    <a th:href="@{/booking/movies/{id}(id=${movie.id})}"
                       class="btn btn-primary w-100">Выбрать сеанс</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Функция для отображения заглушки при ошибке загрузки
    function showFallback(imgElement) {
        console.log('Ошибка загрузки изображения:', imgElement.src);
        imgElement.style.display = 'none';

        // Создаем заглушку
        const placeholder = document.createElement('div');
        placeholder.className = 'no-poster';
        placeholder.innerHTML = `<div>${imgElement.alt}</div>`;

        // Вставляем после изображения
        imgElement.parentElement.appendChild(placeholder);
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.movie-poster').forEach(function(img) {
            // Проверяем, загрузилось ли изображение
            if (img.complete) {
                if (img.naturalHeight === 0) {
                    showFallback(img);
                }
            } else {
                img.addEventListener('error', function() {
                    showFallback(this);
                });
            }
        });
    });
</script>
</body>
</html>